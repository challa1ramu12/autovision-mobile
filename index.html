<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>AutoVision Entry</title>
</head>

<body style="font-family:Arial;padding:20px">

<h2>New Expense</h2>

<input id="vendor" placeholder="Vendor Name" style="width:100%;padding:10px"><br><br>

<input id="amount" type="number" placeholder="Amount" style="width:100%;padding:10px"><br><br>

<input id="photo" type="file" accept="image/*" style="width:100%;padding:10px"><br><br>

<button onclick="submitData()" style="width:100%;padding:15px;background:green;color:white">
Submit
</button>

<p id="msg"></p>

<script>
const SUPABASE_URL = "https://qobnvvhefcxxarchdxsh.supabase.co";
const SUPABASE_KEY = "sb_publishable_UUsw6Eg8stkb543Mbtqv5A_Xd7VDxzX";

async function submitData(){

 const vendor = document.getElementById("vendor").value;
 const amount = document.getElementById("amount").value;
 const photo = document.getElementById("photo").files[0];

 if(!vendor || !amount){
   alert("Fill vendor & amount");
   return;
 }

 let billUrl = null;

 try {

   // Upload photo
   if(photo){
     const fileName = Date.now()+"_"+photo.name;

     const upload = await fetch(
       SUPABASE_URL + "/storage/v1/object/bills/" + fileName,
       {
         method:"POST",
         headers:{
           "apikey":SUPABASE_KEY,
           "Authorization":"Bearer "+SUPABASE_KEY,
           "Content-Type": photo.type
         },
         body: photo
       }
     );

     if(!upload.ok){
       alert("Photo upload failed");
       return;
     }

     billUrl = SUPABASE_URL + "/storage/v1/object/public/bills/" + fileName;
   }

   // Insert invoice via RPC
   const inv = await fetch(SUPABASE_URL+"/rest/v1/rpc/insert_invoice",{
     method:"POST",
     headers:{
       "apikey":SUPABASE_KEY,
       "Authorization":"Bearer "+SUPABASE_KEY,
       "Content-Type":"application/json"
     },
     body:JSON.stringify({
       v_vendor: vendor,
       v_amount: amount,
       v_bill: billUrl
     })
   });

   if(!inv.ok){
     const t = await inv.text();
     alert("Invoice insert failed: "+t);
     return;
   }

   document.getElementById("msg").innerHTML="Saved âœ”";

 } catch(e){
   alert(e.message);
 }

}
</script>

</body>
</html>
