<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>AutoVision Entry</title>
</head>

<body style="font-family:Arial;padding:20px">

<h2>New Expense</h2>

<select id="mode" style="width:100%;padding:10px">
 <option>Cash</option>
 <option>Axis Bank</option>
 <option>UPI</option>
</select><br><br>

<input id="photo" type="file" accept="image/*,application/pdf" style="width:100%;padding:10px"><br><br>

<button onclick="submitData()" style="width:100%;padding:15px;background:green;color:white">
Submit
</button>

<p id="msg"></p>

<script>
const SUPABASE_URL = "https://qobnvvhefcxxarchdxsh.supabase.co";
const SUPABASE_KEY = "sb_publishable_UUsw6Eg8stkb543Mbtqv5A_Xd7VDxzX";

async function submitData(){

 const vendor="";
 const amount=0;
 const mode=document.getElementById("mode").value;
 const photo=document.getElementById("photo").files[0];

 if(!photo){
  alert("Upload bill");
  return;
 }

 let billUrl=null;

 try{

  const fileName=Date.now()+"_"+photo.name;

  const upload=await fetch(
   SUPABASE_URL+"/storage/v1/object/bills/"+fileName,{
    method:"POST",
    headers:{
     apikey:SUPABASE_KEY,
     Authorization:"Bearer "+SUPABASE_KEY,
     "Content-Type":photo.type
    },
    body:photo
   });

  if(!upload.ok){
   alert("Upload failed");
   return;
  }

  billUrl=SUPABASE_URL+"/storage/v1/object/public/bills/"+fileName;

  const inv=await fetch(SUPABASE_URL+"/rest/v1/rpc/insert_invoice",{
   method:"POST",
   headers:{
    apikey:SUPABASE_KEY,
    Authorization:"Bearer "+SUPABASE_KEY,
    "Content-Type":"application/json"
   },
   body:JSON.stringify({
    v_vendor:vendor,
    v_amount:amount,
    v_bill:billUrl,
    v_mode:mode
   })
  });

  if(!inv.ok){
   alert(await inv.text());
   return;
  }

  document.getElementById("msg").innerHTML="Saved âœ”";

 }catch(e){
  alert(e.message);
 }
}
</script>

</body>
</html>
